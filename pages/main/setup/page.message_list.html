<div page-declare=dpage class="w-100 h-auto" onload=onPageLoad(this)><div class="align-items-center d-flex bg-white border flex-row m-0 mb-1 sticky-top"><div class="p-1 me-auto"><input class=form-check-input type=checkbox id=item_all> <label class=form-check-label for=item_all id=item_qty>선택</label></div><div class=p-1><select class="fs_item col-attach form-select" id=disp_type><option class=fs_item value=ALL selected=selected>모두 보기<option class=fs_item value=SERVER>저장된거만 보기<option class=fs_item value=CLIENT>장치거만 보기</select></div><div class=p-1><button type=button class="btn btn-primary" id=btn_add>추가하기</button> <button type=button class="btn btn-primary" id=btn_refresh>재조회</button></div></div><div class="mb-1 card w-100"><div class="align-items-center d-flex card-header pb-1" style=height:35px><div class="" id=item_title>비교</div></div><div class="card-body collapse group_x p-0 show"></div></div></div><script>function onPageLoad(e){var i=e.getPage(),l=e.getParam();function s(e,t,s){var e={date1:e,date2:t},n=(i.find("#disp_type option:selected").val(),s.slice());window.SBalance.request("/main/message/lists",e).then(function(e){console.log("/main/message/lists:",e);var s=i.find(".card-body");s.empty(),e.data.forEach(function(t){var e;null!=t.msg_body&&(t.msg_str=t.msg_body.replace(/(\s*|\r\n|\r|\n)/g,""),SHA_256(t.msg_str),null!=(e=n.find(function(e){if(1!=e.is_found&&e.msg_phone==t.msg_phone&&e.msg_date==t.msg_date&&e.msg_str==t.msg_str)return!0}))?e.is_found=!0:(t.is_found=!1,n.push(t)))}),n.sort(function(e,t){return e.msg_date>t.msg_date?-1:e.msg_date<t.msg_date?1:e.msg_time>t.msg_time?-1:e.msg_time<t.msg_time?1:0});console.log("list... :",n),n.forEach(function(e){var t=$("<div/>");t.addClass("row border border-top-0 border-start-0 border-end-0 m-0 h-100").css("min-height","54px").html(`
    <div class="col-1 border-end d-flex align-items-center p-1 justify-content-center">
        <input class="form-check-input" type="checkbox" id="msg_check">
    </div>
    <div class="col-2 border-end d-flex align-items-center p-1" id="msg_phone">수신번호</div>
    <div class="col-2 border-end d-flex align-items-center p-1 justify-content-center" id="msg_date">날짜</div>
    <div class="col-2 border-end d-flex align-items-center p-1 justify-content-center" id="msg_time">시간</div>
    <div class="col-5 d-flex align-items-center p-1" id="msg_body">내용</div>
    `),1==e.is_found?(t.addClass("bg-light text-secondary"),t.find("#msg_check").prop("disabled",!0)):0==e.is_found?(t.addClass("bg-light text-danger"),t.find("#msg_check").prop("disabled",!0)):t.addClass("bg-light text-primary"),delete e.is_found,t.find("#msg_check").change(function(){console.log("ASDF"),i.find("#item_qty").html(`선택: ${s.find("#msg_check:checked").length} 건/ ${n.length} 건`)}),t.find("#msg_check").prop("midx",e.midx),t.find("#msg_phone").html(e.msg_phone),t.find("#msg_date").html(e.msg_date.substring(4,6)+"-"+e.msg_date.substring(6,8)),t.find("#msg_time").html(e.msg_time.substring(0,2)+":"+e.msg_time.substring(2,4)+":"+e.msg_time.substring(4,6)),t.find("#msg_body").html(e.msg_body),s.append(t)}),i.find("#item_qty").html(`선택: ${i.find("#msg_check:checked").length} 건/ ${n.length} 건`),i.find("#item_all").unbind("click").bind("click",function(){i.find("#msg_check:not(:disabled)").prop("checked",i.find("#item_all").prop("checked")),i.find("#item_qty").html(`선택: ${i.find("#msg_check:checked").length} 건/ ${n.length} 건`),console.log("clicked")})})}console.log("pparam:",l),l.lists.forEach(function(e,t){e.msg_str=e.msg_body.replace(/(\s*|\r\n|\r|\n)/g,""),e.key=SHA_256(e.msg_str),e.midx=t}),s(l.date1,l.date2,l.lists),i.find("#btn_add").click(function(){var o,t,c=i.find("#msg_check:checked").toArray();c.length<=0?window.toast({title_class:"bg-secondary text-white",title_text:"문자 읽기",mesg_text:"추가할 문자를 선택해 주세요."}):(o={is_break:!1,update:function(e){},init:function(){console.log("aaa:",this)}},t=window.openModal("https://lclasser.github.io/sbalance/pages/main/modal/modal.progressp.html",o,function(e){null==e&&(o.is_break=!0)}),o._oninit=function(){o.update(0),c.reduce(function(e,i,d){return e.then(function(){return new Promise(function(s,n){setTimeout(function(){var e,t;1==o.is_break?n("취소 되었습니다."):(e=$(i).prop("midx"),t=l.lists[e],console.log("row:",e,t),window.SBalance.request("/api/message/insert",t).then(function(e){return console.log("/api/message/insert res:",e),o.update(Math.floor(100*(d+1)/c.length)),"Y"==e.error.success?s():n(e.error.message)}))},1e3)})})},Promise.resolve()).then(function(){setTimeout(function(){console.log("finished..."),t.close(!0),window.toast({title_class:"bg-success text-white",title_text:"문자 읽기",mesg_text:"선택된 문자가 추가 되었습니다."}),s(l.date1,l.date2,l.lists)},0)}).catch(function(e){setTimeout(function(){console.log("error...",e),t.close(!1),1==o.is_break?window.toast({title_class:"bg-danger text-white",title_text:"문자 읽기",mesg_text:""+e}):window.toast({title_class:"bg-danger text-white",title_text:"문자 읽기",mesg_text:`선택된 문자의 처리가 실패 했습니다.(${e})`})},0)})})}),i.find("#btn_refresh").click(function(){s(l.date1,l.date2,l.lists)})}</script>