<style>.input_check{flex:1 0 auto}.input_select{display:flex;flex-direction:row;flex:1 0 auto;justify-content:flex-end}.input_select select{width:auto}</style><div page-declare=dpage class="page-column sb-page" onload=onPageLoad(this)><div class="mb-1 align-items-center column-fixed d-flex flex-row flex-wrap m-0 p-1"><div class="p-1 input_check"><input class=form-check-input type=checkbox id=item_all> <label class=form-check-label for=item_all id=item_qty>선택</label></div><div class=input_select><select class="m-1 form-select" id=disp_type style=width:auto><option class=fs_item value=ALL selected=selected>모두 보기<option class=fs_item value=SERVER>저장된거만 보기<option class=fs_item value=CLIENT>장치거만 보기</select> <button type=button class="m-1 btn btn-primary" id=btn_add>추가하기</button> <button type=button class="m-1 btn btn-primary" id=btn_refresh>재조회</button></div></div><div class="mb-1 column-paged sb-list" id=data_list></div></div><script>function onPageLoad(e){var a=e.getPage(),l=e.getParam();function s(e,t,s){var e={date1:e,date2:t},d=(a.find("#disp_type option:selected").val(),s.slice());window.SBalance.request("/main/message/lists",e).then(function(e){console.log("/main/message/lists:",e);var i=a.find("#data_list");function n(){a.find("#item_qty").html(`선택: ${i.find("#msg_check:checked").length} 건<br>전체: ${d.length} 건`)}i.empty(),e.data.forEach(function(t){var e;null!=t.msg_body&&(t.msg_str=t.msg_body.replace(/(\s*|\r\n|\r|\n)/g,""),SHA_256(t.msg_str),null!=(e=d.find(function(e){if(1!=e.is_found&&e.msg_phone==t.msg_phone&&e.msg_date==t.msg_date&&e.msg_str==t.msg_str)return!0}))?e.is_found=!0:(t.is_found=!1,d.push(t)))}),d.sort(function(e,t){return e.msg_date>t.msg_date?-1:e.msg_date<t.msg_date?1:e.msg_time>t.msg_time?-1:e.msg_time<t.msg_time?1:0});console.log("list... :",d),d.forEach(function(e,t){0<t&&i.append('<div class="list-line">');var s=$(`
    <div class="list-row m-0">
        <div class="d-flex flex-column p-1" >
            <div class="d-flex flex-row">
                <div class="p-1">
                    <input class="form-check-input" type="checkbox" id="msg_check">
                </div>
                <div class="p-1 pe-3" id="msg_date">날짜</div>
                <div class="p-1 me-auto" id="msg_time">시간</div>
                <div class="p-1" id="msg_phone">수신번호</div>
            </div>
            <div class="d-flex flex-row">
                <div class="p-1" style="width: 1em;"></div>
                <div class="d-flex align-items-center p-1" id="msg_body">내용</div>
            </div>
        </div>
    </div>
    `);1==e.is_found?(s.addClass("text-secondary"),s.find("#msg_check").prop("disabled",!0)):0==e.is_found?(s.addClass("text-danger"),s.find("#msg_check").prop("disabled",!0)):s.addClass("text-primary"),delete e.is_found,s.find("#msg_check").change(function(){n(),console.log("1111")}),s.find("#msg_check").prop("midx",e.midx),s.find("#msg_phone").html(e.msg_phone),s.find("#msg_date").html(e.msg_date.substring(4,6)+"-"+e.msg_date.substring(6,8)),s.find("#msg_time").html(e.msg_time.substring(0,2)+":"+e.msg_time.substring(2,4)),s.find("#msg_body").html(e.msg_body),s.click(function(e){"msg_check"!=e.target.id&&1!=s.find("#msg_check").prop("disabled")&&(s.find("#msg_check").prop("checked",!s.find("#msg_check").prop("checked")),n())}),i.append(s)}),n(),a.find("#item_all").unbind("click").bind("click",function(){a.find("#msg_check:not(:disabled)").prop("checked",a.find("#item_all").prop("checked")),n()})})}console.log("pparam:",l),l.lists.forEach(function(e,t){e.msg_str=e.msg_body.replace(/(\s*|\r\n|\r|\n)/g,""),e.key=SHA_256(e.msg_str),e.midx=t}),s(l.date1,l.date2,l.lists),a.find("#btn_add").click(function(){var o,t,c=a.find("#msg_check:checked").toArray();c.length<=0?window.toast({title_class:"bg-secondary text-white",title_text:"문자 읽기",mesg_text:"추가할 문자를 선택해 주세요."}):(o={is_break:!1,update:function(e){},init:function(){console.log("aaa:",this)}},t=window.openModal("https://lclasser.github.io/sbalance/pages/main/modal/modal.progressp.html",o,function(e){null==e&&(o.is_break=!0)}),o._oninit=function(){o.update(0),c.reduce(function(e,n,d){return e.then(function(){return new Promise(function(s,i){setTimeout(function(){var e,t;1==o.is_break?i("취소 되었습니다."):(e=$(n).prop("midx"),t=l.lists[e],console.log("row:",e,t),window.SBalance.request("/api/message/insert",t).then(function(e){return console.log("/api/message/insert res:",e),o.update(Math.floor(100*(d+1)/c.length)),"Y"==e.error.success?s():i(e.error.message)}))},1e3)})})},Promise.resolve()).then(function(){setTimeout(function(){console.log("finished..."),t.close(!0),window.toast({title_class:"bg-success text-white",title_text:"문자 읽기",mesg_text:"선택된 문자가 추가 되었습니다."}),s(l.date1,l.date2,l.lists)},0)}).catch(function(e){setTimeout(function(){console.log("error...",e),t.close(!1),1==o.is_break?window.toast({title_class:"bg-danger text-white",title_text:"문자 읽기",mesg_text:""+e}):window.toast({title_class:"bg-danger text-white",title_text:"문자 읽기",mesg_text:`선택된 문자의 처리가 실패 했습니다.(${e})`})},0)})})}),a.find("#btn_refresh").click(function(){s(l.date1,l.date2,l.lists)})}</script>