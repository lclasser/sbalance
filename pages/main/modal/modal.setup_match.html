<style>#dlg_matchlist *{font-size:13px;font-weight:400!important;color:#6a6a6a!important}</style><div class="modal-dialog modal-dialog-centered modal-dialog-scrollable sb-modal" role=document><div class=modal-content><div class=modal-header><h5 class=modal-title id=modal_title>자동 분류</h5><button class=btn-close type=button data-bs-dismiss=modal aria-label=Close></button></div><div class="modal-body sb-form"><div class=sb-row><div class=sb-col><span class=sb-label>지갑</span> <select class=sb-select id=dlg_alias></select></div></div><div class=sb-row><div class=sb-col><span class=sb-label>구분</span> <select class=sb-select id=dlg_class><option class="" value=D>입금<option class="" value=W>출금</select></div></div><div class=sb-row><div class=sb-col><span class=sb-label>순서</span> <input class=sb-input type=text id=dlg_order placeholder="순서 값을 입력하세요."></div></div><div class=sb-row><div class=sb-col><span class=sb-label>분류</span> <select class=sb-select id=dlg_category></select></div></div><div class=sb-row><div class=sb-col><span class=sb-label>설정</span> <input class=sb-input type=text id=dlg_target placeholder="설정 값을 입력하세요."> <button class="sb-label btn btn-secondary" type=button data-bs-toggle=popover data-bs-placement=top data-bs-container=.modal-body data-bs-content="변수 %s:문자열,%d:숫자">?</button> <button type=button class="btn btn-info h-100" id=dlg_search>검색</button></div></div><div class=sb-row><div class=sb-col><span class=sb-label>금액</span> <input class=sb-input type=text id=dlg_money placeholder="금액을 입력하세요.(빈값은 사용안함)"></div></div><div class=sb-row><div class=sb-row><div class="sb-label w-100">검색 결과</div></div><div class="sb-row flex-column"><ul class="list-group list-group-flush show" id=dlg_matchlist></ul></div></div></div><div class=modal-footer><button type=button id=modal_del class="btn btn-lg delete-btn me-auto">삭제</button> <button type=button id=modal_ok class="btn btn-lg insert-btn">설정</button> <button type=button class="btn btn-lg cancel-btn" data-bs-dismiss=modal>취소</button></div></div></div><script>var $modal=window.dmodal.getModal(),param=window.dmodal.getParam();function display_match_find(a,t,e,l){window.SBalance.request("/main/match/match",{acc_key:a,mat_class:t,mat_contents:e,mat_amount:l,limit:5}).then(function(a){stracer("modal.setup_match.html").log("main/match/match:",a.data),$modal.find("#dlg_matchlist").empty(),a.data.length<=0?$modal.find("#dlg_matchlist").append('<li class="list-group-item text-secondary">(없음)</li}'):a.data.forEach(function(a){a=$('<li class="list-group-item d-flex flex-column p-1"><div class="d-flex justify-content-between w-100">'+`<div class="">${displayDate_fromFmtDate(a.sms_date)}</div>`+`<div class="text-end">${moneyFormatter(a.sms_amount)}</div>`+'</div><div class="d-flex justify-content-between w-100">'+`<div class="text-truncate">${a.sms_contents}</div>`+`<div class="text-truncate">${a.sms_memo||""}</div>`+"</div></li}");$modal.find("#dlg_matchlist").append(a)})})}$(function(){var a=$modal.find("[data-bs-toggle='popover']");switch(new bootstrap.Popover(a[0],{trigger:"focus"}),window.SBalance.request("/main/account/list").then(function(a){stracer("modal.setup_match.html").log("/main/account/list:",a),a.data.forEach(function(a){var t="";param.acc_type==a.acc_type&&param.acc_name==a.acc_name&&param.acc_key==a.acc_key&&(t="selected"),$modal.find("#dlg_alias").append($(`<option class="" value="${a.acc_key}" ${t}>[${a.acc_company}] ${a.acc_alias}</option>`))})}),param.sms_class){case"D":case"W":$modal.find("#dlg_class").val(param.sms_class).prop("selected",!0);break;default:$modal.find("#dlg_class").val("(없음)")}eventInputNumber($modal.find("#dlg_order")[0]),$modal.find("#dlg_order").val(param.mat_order||100),window.SBalance.request("/main/category/item/select").then(function(a){var t;$modal.find("#dlg_category").append($('<option class="" value="0"> - </option>')),a.data.forEach(function(a){t=param.sms_category==a.ci_idx?"selected":"",$modal.find("#dlg_category").append($(`<option class="" value="${a.ci_idx}" ${t}>${a.ci_name} (${a.cg_name})</option>`))})}),eventInputNumber($modal.find("#dlg_money")[0]),null!=param.mat_amount&&"0"!=param.mat_amount&&$modal.find("#dlg_money").val(thousandFormatter(param.mat_amount)),$modal.find("#dlg_target").val(param.mat_contents||""),display_match_find(param.acc_key,param.sms_class,param.sms_contents),stracer("modal.setup_match.html").log("init:",param)}),$modal.find("#dlg_search").click(function(){var a=$modal.find("#dlg_alias").val(),t=$modal.find("#dlg_class").val(),e=$modal.find("#dlg_money").val();display_match_find(a,t,$modal.find("#dlg_target").val(),e)}),$modal.find("#modal_del").click(function(){window.openModal("https://lclasser.github.io/sbalance/pages/main/modal/modal.confirm.html",{title:"삭제 확인",content:`"${param.mat_contents}" 매칭을 삭제 하시겠습니까?`,btn_confirm:"삭제",btn_cancel:"취소"},function(a){1==a&&(window.SBalance.request("/main/match/delete",{acc_key:param.acc_key,mat_class:param.mat_class,mat_amount:param.mat_amount,mat_contents:param.mat_contents}).then(function(a){stracer("modal.setup_match.html").log("자동 분류 삭제:",a.error),"Y"==a.error.success?window.toast({title_class:"bg-secondary text-white",title_text:"자동 분류",mesg_text:"자동 분류를 해제 했습니다."}):window.toast({title_class:"bg-danger text-white",title_text:"자동 분류",mesg_text:"자동 분류의 삭제를 실패 했습니다."})}),window.dmodal.exit(!0))})}),$modal.find("#modal_ok").click(function(){var e={acc_key:param.acc_key,mat_class:param.sms_class,mat_amount:param.mat_amount,mat_contents:param.mat_contents,ci_idx:$modal.find("#dlg_category option:selected").val(),mod_key:$modal.find("#dlg_alias").val(),mod_class:$modal.find("#dlg_class").val(),mod_amount:$modal.find("#dlg_money").val(),mod_contents:$modal.find("#dlg_target").val(),mod_order:$modal.find("#dlg_order").val()};e.mod_contents.length<=0?window.toast({title_class:"bg-secondary text-white",title_text:"자동 분류",mesg_text:"설정을 입력하세요."}):e.ci_idx<=0?window.toast({title_class:"bg-secondary text-white",title_text:"자동 분류",mesg_text:"분류를 선택하세요."}):(stracer("modal.setup_match.html").log("inbound:",param,e),window.SBalance.request("/main/match/update",e).then(function(a){stracer("modal.setup_match.html").log("/main/message/update res:",a);var t=null;"Y"==a.error.success?(t={modified:e},window.toast({title_class:"bg-secondary text-white",title_text:"자동 분류",mesg_text:"자동 분류를 저장 했습니다."})):window.toast({title_class:"bg-danger text-white",title_text:"자동 분류",mesg_text:"자동 분류의 저장을 실패 했습니다. (다시 시도)"}),window.dmodal.close(t)}))})</script>