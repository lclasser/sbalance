<div class="modal-dialog modal-dialog-centered modal-dialog-scrollable sb-modal" role=document><div class=modal-content><div class=modal-header><h5 class=modal-title id=modal_title>자동 분류</h5><button class=btn-close type=button data-bs-dismiss=modal aria-label=Close></button></div><div class="modal-body sb-form"><div class=sb-row><div class=sb-col><span class=sb-label>지갑</span> <select class=sb-select id=dlg_alias></select></div></div><div class=sb-row><div class=sb-col><span class=sb-label>구분</span> <select class=sb-select id=dlg_class><option class="" value=D>입금<option class="" value=W>출금</select></div></div><div class=sb-row><div class=sb-col><span class=sb-label>금액</span> <input class=sb-input type=text id=dlg_money></div></div><div class=sb-row><div class=sb-col><span class=sb-label>내용</span> <span class=sb-input type=text id=dlg_contents></span></div></div><div class=sb-row><div class=sb-col><span class=sb-label>분류</span> <select class=sb-select id=dlg_category></select></div></div><div class=sb-row><div class=sb-col><span class=sb-label>설정</span> <input class=sb-input type=text id=dlg_target placeholder="설정 값을 입력하세요.(필수)"> <button class="sb-label btn btn-secondary" type=button data-bs-toggle=popover data-bs-placement=top data-bs-container=.modal-body data-bs-content="%s:문자열, %d:숫자">?</button></div></div><div class=sb-row><div class=sb-col><span class=sb-label>금액</span> <input class=sb-input type=text id=dlg_amount placeholder="금액을 입력하세요.(빈값은 사용안함)"></div></div><div class="border card h-100 mb-1 sb-card"><div class="align-items-center card-header d-flex p-1" style=height:35px><div class=me-auto>자동 분류</div><div class=me-2><button class="btn btn-secondary btn-sm" type=button data-bs-toggle=collapse data-bs-target=.group_x aria-expanded=false aria-controls=.group_x><div class="collapse group_x hide"><i class="fa-solid fa-caret-down"></i></div><div class="collapse group_x show"><i class="fa-solid fa-caret-up"></i></div></button></div></div><div class="collapse group_x show card-body p-0"><ul class="collapse group_x show list-group list-group-flush" id=dlg_matchlist></ul></div></div></div><div class=modal-footer><button type=button id=modal_ok class="btn btn-lg btn-primary">설정</button> <button type=button class="btn btn-secondary btn-lg" data-bs-dismiss=modal>취소</button></div></div></div><script>var $modal=window.dmodal.getModal(),param=window.dmodal.getParam();$(function(){var a=$modal.find("[data-bs-toggle='popover']");switch(new bootstrap.Popover(a[0],{trigger:"focus"}),console.log("param:",param),$modal.find("#dlg_alias").parent().attr("disabled","disabled"),$modal.find("#dlg_alias").attr("disabled","disabled"),window.SBalance.request("/main/account/list").then(function(a){console.log("/main/account/list:",a),a.data.forEach(function(a){var t;"L"!=a.acc_type&&(t=param.acc_key==a.acc_key?"selected":"",$modal.find("#dlg_alias").append($(`<option class="" value="${a.acc_key}" ${t}>[${a.acc_company}] ${a.acc_alias}</option>`)))})}),$modal.find("#dlg_class").parent().attr("disabled","disabled"),$modal.find("#dlg_class").attr("disabled","disabled"),param.sms_class){case"D":case"W":$modal.find("#dlg_class").val(param.sms_class).prop("selected",!0);break;default:$modal.find("#dlg_class").val("(없음)")}$modal.find("#dlg_money").parent().attr("disabled","disabled"),$modal.find("#dlg_money").attr("disabled","disabled"),$modal.find("#dlg_money").val(moneyFormatter(param.sms_amount)),$modal.find("#dlg_contents").parent().attr("disabled","disabled"),$modal.find("#dlg_contents").attr("disabled","disabled"),$modal.find("#dlg_contents").html(param.sms_contents||""),$modal.find("#dlg_target").val(param.mat_contents||""),window.SBalance.request("/main/category/item/select").then(function(a){var t;a.data.forEach(function(a){t=param.sms_category==a.ci_idx?"selected":"",$modal.find("#dlg_category").append($(`<option class="" value="${a.ci_idx}" ${t}>${a.ci_name} (${a.cg_name})</option>`))})}),function e(s,l,d){window.SBalance.request("/main/match/find",{acc_key:s,mat_class:l,sms_contents:d}).then(function(a){console.log("main/match/find:",a.data),$modal.find("#dlg_matchlist").empty(),a.data.length<=0?$modal.find("#dlg_matchlist").append('<li class="list-group-item text-secondary">(없음)</li}'):a.data.forEach(function(a){var t=$('<li class="list-group-item d-flex">'+`<div class="align-self-center">"${a.mat_contents}"</div>`+'<div class="ms-auto"><button class="btn btn-sm btn-danger" id="mat_del">삭제</button></div></li}');$modal.find("#dlg_matchlist").append(t),t.find("#mat_del").click(function(){window.SBalance.request("/main/match/delete",{acc_key:a.acc_key,mat_class:a.mat_class,mat_contents:a.mat_contents}).then(function(a){console.log("자동 분류 삭제:",a.error),"Y"==a.error.success?window.toast({title_class:"bg-secondary text-white",title_text:"자동 분류",mesg_text:"자동 분류를 해제 했습니다."}):window.toast({title_class:"bg-danger text-white",title_text:"자동 분류",mesg_text:"자동 분류의 해제를 실패 했습니다."}),e(s,l,d)})})})})}(param.acc_key,param.sms_class,param.sms_contents),console.log("init:",param)}),$modal.find("#modal_ok").click(function(){var e={acc_key:param.acc_key,mat_class:param.sms_class,mat_amount:$modal.find("#dlg_amount").val(),mat_contents:$modal.find("#dlg_target").val(),ci_idx:$modal.find("#dlg_category option:selected").val()};e.mat_contents.length<=0?window.toast({title_class:"bg-secondary text-white",title_text:"자동 분류",mesg_text:"설정 값을 입력하세요."}):e.ci_idx<=0?window.toast({title_class:"bg-secondary text-white",title_text:"자동 분류",mesg_text:"분류를 선택하세요."}):1!=compareMatch(e,param)?window.toast({title_class:"bg-secondary text-white",title_text:"자동 분류",mesg_text:"설정 값과 '내용'이 매칭되지 않습니다."}):(console.log("inbound:",param,e),window.SBalance.request("/main/match/insert",e).then(function(a){console.log("/main/message/insert res:",a);var t;"Y"==a.error.success?(t={modified:e},window.toast({title_class:"bg-secondary text-white",title_text:"자동 분류",mesg_text:"자동 분류를 저장 했습니다."}),window.dmodal.close(t)):window.toast({title_class:"bg-danger text-white",title_text:"자동 분류",mesg_text:a.error.code?a.error.message:"자동 분류의 저장을 실패 했습니다. (다시 시도)"})}))})</script>